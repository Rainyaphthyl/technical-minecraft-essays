# 不均匀瓜密度计算

## 问题描述

在简化的瓜机模型中，瓜密度被视作在下落管道内均匀分布，末影人的生命进程被分为可以捡到瓜和不可以捡到瓜的两类。然而这种模型并不符合实际情况。

## 捡瓜概率序列

末影人在全生命周期中捡到瓜的概率本质上是由各个时刻捡到瓜的概率决定的。对于在任意时刻捡到瓜的概率，则需要考虑能够触发执行AI任务的概率和触发任务后可以捡到的瓜的密度这两方面。在本节中，我们暂时只考虑触发AI任务的平均值，或者说将其视为恒定值，而只考虑瓜密度的非均匀性。

我们暂时不考虑捡瓜概率的内部细节，只考虑末影人生命中的捡瓜概率序列。

设某一只末影人的生命包含 $N$ gt，编号为 $n = 1, 2,\cdots, N$ ，在编号为 $n$ 的gt中捡到瓜的概率为 $p_n$ 。

沿用上文的符号，将全生命周期的总搬瓜率记作 $G$ ，可以得出 $G$ 与 $\left\lbrace p_i \right\rbrace$ 的关系：

$$
G = 1-\prod_{i=1}^{N}\left(1-p_i\right) 
$$

如果希望找出一个等效的平均瞬时瓜密度 $p_g$ ，则根据上文结论，应该有以下计算方式：

$$
G = 1 - \left(1-p_g\right)^{w}
$$

其中，$w$ 是末影人能够捡到瓜的总时长。

为了与平均值的计算相匹配，捡瓜概率序列应该仅截取能捡到瓜的这段时间， $G$ 与 $\left\lbrace p_i \right\rbrace$ 的关系应修改为：

$$
G = 1-\prod_{i=1}^{w}\left(1-p_i\right) 
$$

其中， $\left\lbrace p_i \right\rbrace$ 也作出相应修改： $p_i$ 表示在捡得到瓜的时段内部相对编号为 $i$ 的时刻，而不是全生命周期中的同编号时刻。

联立上述公式可以发现：

$$
G = 1-\left(1-p_g\right)^{w}=1-\prod_{i=1}^{w}\left(1-p_i\right)
$$

$$
w\ln{\left(1-p_g\right)}=\sum_{i=1}^{w}\ln{\left(1-p_i\right)}
$$

注意到 $\ln{\left(1-p\right)}$ 这个量可能有一些意义。设 $q = -\ln{\left(1-p\right)}$ ，可以注意到等效平均值 $q_g$ 就是 $q_i$ 的算术平均值：

$$
q_g = \frac{1}{w}\sum_{i=1}^{w}{q_i} = \bar{q}
$$

$$
G = 1 - \mathrm{e}^{-q_g w}
$$

在本节后续的公式中，下标 $g$ 的（如 $p_g$ ）表示实际用于计算的等效瞬时概率，上方加横杠的（如 $\bar{p}$ ）表示算术平均值。此处需要重点关注的一件事是：$p_g$ 与 $\bar{p}$ 并不一定相等。

$$
p_g = 1 - \sqrt[w]{\prod_{i=1}^{w}{\left(1-p_i\right)}}
$$

$$
V_g = \frac{V_A}{\varepsilon}\cdot p_g = 
\frac{V_A}{\varepsilon}\left(1 - \sqrt[w]{\prod_{i=1}^{w}{\left(1-\varepsilon\cdot\frac{V_i}{V_A}\right)}} \right)
$$

$$
V_g = 
\frac{V_A}{\varepsilon} - \sqrt[w]{\prod_{i=1}^{w}{\left(\frac{V_A}{\varepsilon}-V_i\right)}}
$$

根据几何平均与算术平均的关系，很容易得出：

$$
1 - p_g = \sqrt[w]{\prod_{i=1}^{w}{\left(1-p_i\right)}} \le 
\frac{1}{w}\sum_{i=1}^{w}{\left(1-p_i\right)}=1-\bar{p}
$$

$$
p_g \ge \bar{p}
$$

## 捡瓜概率的实际取值

考虑某个每层高度为2格（一层为泥土和耕地，另一层为西瓜）、每单元大约包含9个瓜（以实际可捡数量统计，应为每层 $8.75$ 瓜）的下落管道，末影人的运动轨迹将决定实际的瓜密度序列：当末影人周围仅有1层瓜时，密度取到最小值；有2层瓜时，取到最大值。实际的密度将在1层与2层之间，对于此案例来说，瓜数量 $V$ 可能取值范围是 $\left[8.75, 17.50\right]$ 。考虑 $V_A = 48.0$ ，也可以得到瓜密度 $\mu = V / V_A $ 的分布范围。

考虑上文的瞬时搬瓜率公式：

$$p = \varepsilon\cdot\mu = \varepsilon\cdot\frac{V}{V_A}$$

其中：

$$\varepsilon _0 = \frac{1}{20}$$

$$\varepsilon = \frac{\varepsilon _0+\varepsilon _0^2+\varepsilon _0^3}{3} = \frac{421}{24000} \approx \frac{1}{57} \approx 0.01754$$

可以计算出 $p_i$ 的实际可能取值范围约为 $\left[3.1977\times {10}^{-3}, 6.3954\times {10}^{-3}\right]$ 。需要注意，该范围中的值仅在末影人处在下落管道中的时刻可以取到；不考虑管道之外的情形。
